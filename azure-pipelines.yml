# Azure Pipelines YAML for MuleSoft Projects
# ‚úÖ FIXED: Explicit Maven 3.9.10 installation for Azure compatibility
# ‚úÖ Java 17 + Mule Maven Plugin 4.6.0

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: disable.coverage.autogenerate
    value: 'true'
  - name: MAVEN_VERSION
    value: '3.9.10'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: MAVEN_HOME
    value: /opt/maven
  - name: PROJECT_NAME
    value: $[variables.projectName]
  - name: MULE_ORG
    value: $[variables.muleOrg]
  - name: MULE_ORG_ID
    value: $[variables.muleOrgId]

stages:
  - stage: Build
    displayName: 'Build and Test Stage'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Job'
        steps:
          # ‚úÖ CRITICAL STEP 1: Download settings.xml from Azure Secure Files
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings from Secure Files'
            inputs:
              secureFile: 'settings.xml'
          
          # ‚úÖ CRITICAL STEP 2: Install Maven 3.9.10 Explicitly
          - script: |
              echo "üîß Installing Maven $(MAVEN_VERSION) explicitly..."
              echo "Current Maven version (pre-installed):"
              mvn --version || echo "Maven not found"
              
              echo ""
              echo "Downloading Maven $(MAVEN_VERSION)..."
              wget -q https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz
              
              echo "Extracting Maven..."
              tar -xzf apache-maven-$(MAVEN_VERSION)-bin.tar.gz
              
              echo "Installing to $(MAVEN_HOME)..."
              sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
              sudo mv apache-maven-$(MAVEN_VERSION) $(MAVEN_HOME)
              
              echo "Setting up environment..."
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo ""
              echo "‚úÖ Maven $(MAVEN_VERSION) installed successfully!"
              $(MAVEN_HOME)/bin/mvn --version
              
              # Verify it's the correct version
              ACTUAL_VERSION=$($(MAVEN_HOME)/bin/mvn --version | grep "Apache Maven" | awk '{print $3}')
              if [ "$ACTUAL_VERSION" = "$(MAVEN_VERSION)" ]; then
                echo "‚úÖ Version verification passed: $ACTUAL_VERSION"
              else
                echo "‚ùå ERROR: Expected $(MAVEN_VERSION), got $ACTUAL_VERSION"
                exit 1
              fi
            displayName: 'Install Maven 3.9.10'
          
          # ‚úÖ STEP 3: Install settings.xml to Maven directory
          - script: |
              echo "üì¶ Installing Maven settings.xml..."
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              
              echo "‚úÖ settings.xml installed successfully"
              echo "Location: ~/.m2/settings.xml"
              
              # Verify file exists
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ Verified: settings.xml exists"
              else
                echo "‚ùå ERROR: settings.xml not found!"
                exit 1
              fi
              
              # Show structure (without credentials)
              echo ""
              echo "Settings.xml structure:"
              grep -E '<server>|<id>|</server>' ~/.m2/settings.xml | head -20 || echo "Could not parse"
            displayName: 'Install Maven Settings'

          # ‚úÖ STEP 4: Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Install Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # ‚úÖ STEP 5: Verify Environment
          - script: |
              echo "üîç Verifying build environment..."
              echo ""
              echo "=== Java Version ==="
              java -version
              
              echo ""
              echo "=== Maven Version ==="
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              mvn --version
              
              echo ""
              echo "=== Maven Home ==="
              echo "M2_HOME: $(MAVEN_HOME)"
              echo "PATH: $PATH"
              
              echo ""
              echo "=== POM Configuration ==="
              if [ -f pom.xml ]; then
                echo "Mule Maven Plugin Version:"
                grep -A 1 "mule.maven.plugin.version" pom.xml || echo "Not found in properties"
                echo ""
                echo "Java Version:"
                grep -A 1 "maven.compiler.source\|maven.compiler.target" pom.xml || echo "Not found"
              else
                echo "‚ö†Ô∏è pom.xml not found"
              fi
              
              echo ""
              echo "‚úÖ Environment verification complete"
            displayName: 'Verify Build Environment'
            env:
              M2_HOME: $(MAVEN_HOME)

          # ‚úÖ STEP 6: Cache Maven dependencies
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # ‚úÖ STEP 7: Install Anypoint CLI
          - script: |
              echo "üì¶ Installing Anypoint CLI..."
              npm install -g anypoint-cli@latest
              anypoint-cli --version
              echo "‚úÖ Anypoint CLI installed"
            displayName: 'Install Anypoint CLI'

          # ‚úÖ STEP 8: API Governance Validation
          - script: |
              echo "üõ°Ô∏è Running API Governance Validation..."
              
              # Create ZIP for validation if needed
              if [ ! -f "$(PROJECT_NAME).zip" ]; then
                echo "Creating project ZIP..."
                zip -r $(PROJECT_NAME).zip . -x "*.git*" -x "target/*"
              fi
              
              # Run validation
              anypoint-cli \
                --username='$(anypointUsername)' \
                --password='$(anypointPassword)' \
                --organization='$(MULE_ORG)' \
                governance api validate \
                --rulesets ruleset.yaml \
                $(PROJECT_NAME).zip || true
              
              echo "‚úÖ API Governance validation completed"
            displayName: 'API Governance Validation'
            continueOnError: true
            condition: and(succeeded(), ne(variables['MULE_ORG'], ''))

          # ‚úÖ STEP 9: Maven Validate (using explicit Maven path)
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "Running Maven validate..."
              mvn validate \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -s ~/.m2/settings.xml
            displayName: 'Maven Validate'
            continueOnError: true
            env:
              M2_HOME: $(MAVEN_HOME)

          # # ‚úÖ STEP 10: MUnit Tests (using explicit Maven path)
          # - script: |
          #     export M2_HOME=$(MAVEN_HOME)
          #     export PATH=$(MAVEN_HOME)/bin:$PATH
              
          #     echo "Running MUnit tests..."
          #     mvn test \
          #       -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
          #       -Dsecure.key=mule \
          #       -Dmule.env=dev \
          #       -Dproject.version=1.0.0 \
          #       -s ~/.m2/settings.xml
          #   displayName: 'MUnit Tests'
          #   continueOnError: false
          #   env:
          #     M2_HOME: $(MAVEN_HOME)

          # # ‚úÖ STEP 11: Publish Test Results
          # - task: PublishTestResults@2
          #   displayName: 'Publish Test Results'
          #   condition: succeededOrFailed()
          #   inputs:
          #     testResultsFormat: 'JUnit'
          #     testResultsFiles: '**/surefire-reports/TEST-*.xml'
          #     mergeTestResults: true
          #     failTaskOnFailedTests: false
          #     testRunTitle: 'MUnit Test Results'

          # ‚úÖ STEP 12: Maven Package (using explicit Maven path)
          - script: |
              export M2_HOME=$(MAVEN_HOME)
              export PATH=$(MAVEN_HOME)/bin:$PATH
              
              echo "Running Maven package..."
              mvn clean package \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -DskipTests \
                -s ~/.m2/settings.xml
              
              echo "‚úÖ Package created successfully"
              ls -lh target/*.jar
            displayName: 'Maven Package'
            env:
              M2_HOME: $(MAVEN_HOME)

          # # ‚úÖ STEP 13: SonarQube Analysis (optional)
          # - script: |
          #     if [ -n "$(SONAR_TOKEN)" ]; then
          #       export M2_HOME=$(MAVEN_HOME)
          #       export PATH=$(MAVEN_HOME)/bin:$PATH
                
          #       echo "Running SonarQube analysis..."
          #       mvn sonar:sonar \
          #         -Dsonar.host.url=$(SONAR_HOST_URL) \
          #         -Dsonar.login=$(SONAR_TOKEN) \
          #         -s ~/.m2/settings.xml || true
          #     else
          #       echo "‚ö†Ô∏è SonarQube token not configured, skipping analysis"
          #     fi
          #   displayName: 'SonarQube Analysis'
          #   continueOnError: true
          #   condition: succeededOrFailed()
          #   env:
          #     M2_HOME: $(MAVEN_HOME)

          # ‚úÖ STEP 14: Copy Build Artifacts
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                pom.xml
                settings.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: false

          # ‚úÖ STEP 15: Publish Pipeline Artifacts
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Pipeline Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'drop'

  # # ‚úÖ DEPLOY STAGE: CloudHub Deployment
  # - stage: Deploy
  #   displayName: 'Deploy to CloudHub'
  #   dependsOn: Build
  #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  #   jobs:
  #     - deployment: DeployToCloudHub
  #       displayName: 'Deploy to CloudHub Sandbox'
  #       environment: 'Sandbox'
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               # Re-install Maven 3.9.10 for deployment
  #               - script: |
  #                   echo "üîß Setting up Maven $(MAVEN_VERSION) for deployment..."
  #                   wget -q https://archive.apache.org/dist/maven/maven-3/$(MAVEN_VERSION)/binaries/apache-maven-$(MAVEN_VERSION)-bin.tar.gz
  #                   tar -xzf apache-maven-$(MAVEN_VERSION)-bin.tar.gz
  #                   sudo rm -rf $(MAVEN_HOME) 2>/dev/null || true
  #                   sudo mv apache-maven-$(MAVEN_VERSION) $(MAVEN_HOME)
  #                   $(MAVEN_HOME)/bin/mvn --version
  #                 displayName: 'Setup Maven for Deploy'
                
  #               # Re-download settings.xml
  #               - task: DownloadSecureFile@1
  #                 name: mavenSettingsDeploy
  #                 displayName: 'Download Maven Settings'
  #                 inputs:
  #                   secureFile: 'settings.xml'
                
  #               - script: |
  #                   mkdir -p ~/.m2
  #                   cp $(mavenSettingsDeploy.secureFilePath) ~/.m2/settings.xml
  #                 displayName: 'Install Maven Settings for Deploy'

  #               # Download build artifacts
  #               - download: current
  #                 artifact: drop
  #                 displayName: 'Download Build Artifacts'

  #               # Deploy to CloudHub
  #               - script: |
  #                   export M2_HOME=$(MAVEN_HOME)
  #                   export PATH=$(MAVEN_HOME)/bin:$PATH
                    
  #                   cd $(Pipeline.Workspace)/drop
                    
  #                   echo "üöÄ Deploying to CloudHub..."
  #                   mvn deploy \
  #                     -DskipTests \
  #                     -Dmule.version=4.9.0 \
  #                     -Dcloudhub.environment=Sandbox \
  #                     -Danypoint.username='$(anypointUsername)' \
  #                     -Danypoint.password='$(anypointPassword)' \
  #                     -s ~/.m2/settings.xml
                    
  #                   echo "‚úÖ Deployment completed successfully"
  #                 displayName: 'Deploy to CloudHub'
  #                 env:
  #                   M2_HOME: $(MAVEN_HOME)